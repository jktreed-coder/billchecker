<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Tibber Fakturaanalyse v9.0</title>

<style>
body{
    margin:0;
    background:black;
    color:white;
    font-family:Inter,Arial,sans-serif;
    display:flex;
    justify-content:center;
    padding:40px;
}
.container{max-width:650px;width:100%;text-align:center}
h1{font-size:2.2rem;margin-bottom:6px}
h3{font-size:1rem;color:#ccc;line-height:1.45}
.button,.uploadBtn{
    background:#1ED0E7;color:black;border:none;
    padding:14px 28px;border-radius:50px;
    font-weight:600;cursor:pointer;margin-top:18px
}
.fileHint{font-size:.85rem;color:#aaa;margin-top:10px}
.spinner{
    display:none;width:36px;height:36px;margin:24px auto;
    border:4px solid rgba(255,255,255,.2);
    border-top:4px solid #1ED0E7;border-radius:50%;
    animation:spin .9s linear infinite
}
@keyframes spin{to{transform:rotate(360deg)}}
#results,#comparisonBox{
    background:#0f0f0f;padding:25px;border-radius:14px;
    margin-top:30px;text-align:left;display:none
}
.warn{color:#FFD24C;font-size:.85rem;margin-bottom:10px}
input.valueField{
    width:160px;padding:6px 8px;background:#222;
    border:1px solid #555;border-radius:6px;
    color:#1ED0E7;text-align:right
}
.green{color:#4CFF4C;font-size:1.8rem;font-weight:700}
.toggleExplain{color:#1ED0E7;cursor:pointer;text-decoration:underline}
#detailsBox{
    background:#111;padding:18px;border-radius:8px;
    margin-top:16px;display:none;color:#ccc
}
</style>
</head>

<body>
<div class="container">

<h1>Fakturaanalyse</h1>
<h3>
Last opp strømregningen din. Vi identifiserer påslag og månedsavgift
automatisk, uansett leverandør.
</h3>

<label for="fileInput" class="uploadBtn">Last opp strømregning</label>
<input id="fileInput" type="file" accept=".pdf,.jpg,.png" style="display:none">
<div class="fileHint" id="fileHint">Støttede filtyper: .jpg, .png, .pdf</div>

<button class="button" onclick="processFile()">Beregn</button>
<div id="spinner" class="spinner"></div>

<div id="results">
<b>Funnet i strømregningen</b><br><br>

Forbruk (kWh):<br>
<input id="inpForbruk" class="valueField"><br>
<div id="warnForbruk" class="warn">Ikke funnet i faktura</div>

Påslag (øre/kWh):<br>
<input id="inpPåslag" class="valueField"><br>
<div id="warnPåslag" class="warn">Ikke funnet i faktura</div>

Månedsavgift (kr):<br>
<input id="inpMnd" class="valueField"><br>
<div id="warnMnd" class="warn">Ikke funnet i faktura</div>

<button class="button" onclick="compare()">Sammenlign med Tibber</button>
</div>

<div id="comparisonBox">
<div id="comparisonResult"></div>
<div class="toggleExplain" onclick="toggleDetails()">Vis detaljert forklaring</div>
<div id="detailsBox"></div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.2/tesseract.min.js"></script>

<script>
fileInput.onchange=()=>fileHint.textContent=fileInput.files[0]?.name||"";

function showSpinner(x){spinner.style.display=x?"block":"none"}

async function processFile(){
    if(!fileInput.files[0])return;
    showSpinner(true);
    const f=fileInput.files[0];
    let text="";
    if(f.type==="application/pdf") text=await extractPDF(f);
    else text=(await Tesseract.recognize(f,"nor")).data.text;
    const data=parseBill(text);
    fill(data);
    showSpinner(false);
}

async function extractPDF(f){
    const buf=await f.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    let out="";
    for(let i=1;i<=pdf.numPages;i++){
        const p=await pdf.getPage(i);
        const c=await p.getTextContent();
        out+=c.items.map(t=>t.str).join(" ")+"\n";
    }
    return out;
}

/* ---------- BILL TYPE DETECTION ---------- */

function detectMode(t){
    t=t.toLowerCase();
    if(/tibber-abonnement|grid rewards|kWt/.test(t)) return "TIBBER_UI";
    if(/strøm fra|fjordkraft|ishavskraft|los|lyse/.test(t)) return "SUPPLIER_PDF";
    return "GENERIC";
}

/* ---------- PARSERS ---------- */

function parseBill(t){
    const mode=detectMode(t);
    if(mode==="TIBBER_UI") return parseTibberUI(t);
    if(mode==="SUPPLIER_PDF") return parseSupplierPDF(t);
    return parseGeneric(t);
}

/* Tibber app */
function parseTibberUI(t){
    const lines=t.toLowerCase().split(/\n+/);
    let f,p,m;
    lines.forEach(l=>{
        if(/kwh/.test(l)&&!f){
            const r=l.match(/(\d[\d.,]*)\s*kwh/); if(r) f=+r[1].replace(",",".");
        }
        if(/påslag/.test(l)){
            const r=l.match(/(\d[\d.,]*)\s*øre/); if(r) p=+r[1].replace(",",".");
        }
        if(/tibber-abonnement/.test(l)){
            const r=l.match(/(\d[\d.,]*)\s*kr/); if(r) m=+r[1].replace(",",".");
        }
    });
    return {forbruk:f,påslag:p,mnd:m};
}

/* Supplier PDFs */
function parseSupplierPDF(t){
    const lines=t.toLowerCase().split(/\n+/);
    let f,p,m,stop=false;
    lines.forEach(l=>{
        if(/nettleie/.test(l)) stop=true;
        if(stop) return;

        if(!f){
            const r=l.match(/(\d[\d.,]*)\s*kwh/);
            if(r) f=+r[1].replace(",",".");
        }
        if(/påslag/.test(l)){
            const r=l.match(/(\d[\d.,]*)\s*øre/);
            if(r){
                const v=+r[1].replace(",",".");
                if(v>=2&&v<=20) p=v;
            }
        }
        if(/månedsavgift|fastbeløp|abonnementsavgift|administrasjon/.test(l)&&!m){
            const r=l.match(/(\d[\d.,]*)\s*kr/);
            if(r) m=+r[1].replace(",",".");
        }
    });
    return {forbruk:f,påslag:p,mnd:m};
}

/* Generic fallback */
function parseGeneric(t){
    const lines=t.toLowerCase().split(/\n+/);
    let f,p,m;
    lines.forEach(l=>{
        if(!f){
            const r=l.match(/(\d[\d.,]*)\s*kwh/);
            if(r) f=+r[1].replace(",",".");
        }
        if(/påslag/.test(l)){
            const r=l.match(/(\d[\d.,]*)\s*øre/);
            if(r){
                const v=+r[1].replace(",",".");
                if(v>=2&&v<=20) p=v;
            }
        }
        if(/månedsavgift|abonnement/.test(l)&&!m){
            const r=l.match(/(\d[\d.,]*)\s*kr/);
            if(r) m=+r[1].replace(",",".");
        }
    });
    return {forbruk:f,påslag:p,mnd:m};
}

/* ---------- UI ---------- */

function fill(d){
    results.style.display="block";

    inpForbruk.value=d.forbruk||"";
    warnForbruk.style.display=d.forbruk?"none":"block";

    inpPåslag.value=d.påslag||"";
    warnPåslag.style.display=d.påslag?"none":"block";

    inpMnd.value=d.mnd||"";
    warnMnd.style.display=d.mnd?"none":"block";
}

function compare(){
    const f=+inpForbruk.value||0;
    const p=+inpPåslag.value||0;
    const m=+inpMnd.value||0;
    const diff=f*p/100+m-(f*3.4/100+49);
    comparisonResult.innerHTML=
        diff>0
        ? `<div class="green">Du sparer ${diff.toFixed(0)} kr per måned</div>`
        : `Tibber blir dyrere`;
    comparisonBox.style.display="block";
}

function toggleDetails(){
    const f=+inpForbruk.value||0;
    const p=+inpPåslag.value||0;
    const m=+inpMnd.value||0;
    detailsBox.innerHTML=`
    <b>Din avtale</b><br>
    Påslag: ${p} øre<br>
    Månedsavgift: ${m} kr<br><br>
    <b>Tibber</b><br>
    Påslag: 3,4 øre<br>
    Månedsavgift: 49 kr
    `;
    detailsBox.style.display=
        detailsBox.style.display==="block"?"none":"block";
}
</script>
</body>
</html>
