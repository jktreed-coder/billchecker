<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Tibber Fakturaanalyse v12.1</title>

<style>
@font-face{font-family:"Silka";src:url("Silka-Regular.woff2") format("woff2");font-weight:400;}
@font-face{font-family:"Silka";src:url("Silka-SemiBold.woff2") format("woff2");font-weight:600;}

body{
    margin:0;
    background:black;
    color:white;
    font-family:Silka,Inter,Arial,sans-serif;
    display:flex;
    justify-content:center;
    padding:60px 20px;
}

.container{
    width:100%;
    max-width:700px;
    text-align:center;
}

h1{font-size:2.6rem;margin-bottom:10px;}
h3{font-size:1.1rem;color:#aaa;font-weight:400;margin-bottom:40px;}

.primaryBtn{
    background:#1ED0E7;
    color:black;
    padding:16px 36px;
    border-radius:999px;
    font-weight:600;
    cursor:pointer;
    border:none;
    font-size:1rem;
}

.secondaryBtn{
    margin-top:14px;
    background:#1ED0E7;
    color:black;
    padding:12px 28px;
    border-radius:999px;
    font-weight:600;
    cursor:pointer;
    border:none;
}

.spinner{
    display:none;
    width:40px;
    height:40px;
    margin:30px auto;
    border:4px solid rgba(255,255,255,.2);
    border-top:4px solid #1ED0E7;
    border-radius:50%;
    animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

.card{
    margin-top:50px;
    background:linear-gradient(145deg,#111,#0a0a0a);
    padding:36px;
    border-radius:24px;
    text-align:left;
    display:none;
}

.field{
    margin-bottom:26px;
}

.label{
    font-size:1rem;
    margin-bottom:6px;
}

input{
    width:100%;
    max-width:260px;
    padding:10px 14px;
    background:#1b1b1b;
    border:1px solid #333;
    border-radius:10px;
    color:#1ED0E7;
    font-size:1.1rem;
    text-align:right;
}

.warn{
    margin-top:6px;
    font-size:.85rem;
    color:#FFD24C;
}

.green{color:#4CFF4C;font-size:1.8rem;font-weight:700}
.red{color:#FF5B5B;font-size:1.8rem;font-weight:700}
</style>
</head>

<body>
<div class="container">

<h1>Fakturaanalyse</h1>
<h3>Last opp strømregningen din</h3>

<label class="primaryBtn">
    Last opp
    <input id="fileInput" type="file" accept=".pdf,.jpg,.jpeg,.png" hidden>
</label>
<br>
<button class="secondaryBtn" onclick="processFile()">Beregn</button>

<div id="spinner" class="spinner"></div>

<div id="results" class="card">

<div class="field">
    <div class="label">Totalt forbruk kWh</div>
    <input id="inpForbruk">
    <div id="wF" class="warn">Ikke funnet automatisk</div>
</div>

<div class="field">
    <div class="label">Påslag øre per kWh</div>
    <input id="inpPåslag">
    <div id="wP" class="warn">Ikke funnet automatisk</div>
</div>

<div class="field">
    <div class="label">Månedsavgift kr</div>
    <input id="inpMnd">
    <div id="wM" class="warn">Ikke funnet automatisk</div>
</div>

<button class="primaryBtn" onclick="compare()">Sammenlign</button>

</div>

<div id="comparisonBox" class="card">
    <div id="comparisonResult"></div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.2/tesseract.min.js"></script>

<script>
const fileInput=document.getElementById("fileInput");
const spinner=document.getElementById("spinner");

async function processFile(){
 if(!fileInput.files[0])return;
 spinner.style.display="block";
 let text="";
 const f=fileInput.files[0];

 if(f.type==="application/pdf"){
  text=await readPDF(f);
  text+=" "+await ocrPDF(f);
 }else{
  text=(await Tesseract.recognize(f,"nor+eng")).data.text;
 }

 fill(parse(text));
 spinner.style.display="none";
}

async function readPDF(f){
 const pdf=await pdfjsLib.getDocument({data:await f.arrayBuffer()}).promise;
 let out="";
 for(let i=1;i<=pdf.numPages;i++){
  const p=await pdf.getPage(i);
  const c=await p.getTextContent();
  out+=c.items.map(x=>x.str).join(" ")+" ";
 }
 return out;
}

async function ocrPDF(f){
 const pdf=await pdfjsLib.getDocument({data:await f.arrayBuffer()}).promise;
 const p=await pdf.getPage(1);
 const v=p.getViewport({scale:3});
 const c=document.createElement("canvas");
 c.width=v.width;c.height=v.height;
 await p.render({canvasContext:c.getContext("2d"),viewport:v}).promise;
 return (await Tesseract.recognize(c,"nor+eng")).data.text;
}

function parse(raw){
 const clean=raw.toLowerCase().replace(/,/g,".").replace(/\s+/g," ");
 const num=clean.replace(/ø/g,"o");

 let forbruk=null,påslag=null,mnd=null;

 const kwh=[...num.matchAll(/(\d{2,6}(?:\.\d+)?)\s*kwh/g)]
  .map(x=>+x[1]).filter(v=>v>50&&v<20000);
 if(kwh.length)forbruk=Math.max(...kwh);

 const pZone=clean.slice(clean.indexOf("påslag")-150,clean.indexOf("påslag")+150);
 const pVals=[...pZone.matchAll(/(\d{1,2}(?:\.\d+)?)/g)]
  .map(x=>+x[1]).filter(v=>v>0&&v<20);
 if(pVals.length)påslag=pVals[0];

 const mZone=clean.match(/(månedsavgift|fastbeløp|abonnement)[\s\S]{0,150}/);
 if(mZone){
  const mVals=[...mZone[0].matchAll(/(\d{1,3}(?:\.\d+)?)/g)]
   .map(x=>+x[1]).filter(v=>v>0&&v<200);
  if(mVals.length)mnd=mVals[0];
 }

 return{forbruk,påslag,mnd};
}

function fill(d){
 document.getElementById("results").style.display="block";
 inpForbruk.value=d.forbruk||"";wF.style.display=d.forbruk?"none":"block";
 inpPåslag.value=d.påslag||"";wP.style.display=d.påslag?"none":"block";
 inpMnd.value=d.mnd||"";wM.style.display=d.mnd?"none":"block";
}

function compare(){
 const f=+inpForbruk.value||0;
 const p=+inpPåslag.value||0;
 const m=+inpMnd.value||0;
 const diff=f*p/100+m-(f*3.4/100+49);
 document.getElementById("comparisonBox").style.display="block";
 comparisonResult.innerHTML=diff>0
 ?`<div class="green">Du sparer ${diff.toFixed(0)} kr per måned</div>`
 :`<div class="red">Tibber er litt dyrere</div>`;
}
</script>
</body>
</html>
