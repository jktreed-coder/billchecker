<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Tibber Fakturaanalyse v8.1</title>

<style>
@font-face {
    font-family:"Silka";
    src:url("Silka-Regular.woff2") format("woff2"),
        url("Silka-Regular.woff") format("woff");
    font-weight:400;
}
@font-face {
    font-family:"Silka";
    src:url("Silka-SemiBold.woff2") format("woff2"),
        url("Silka-SemiBold.woff") format("woff");
    font-weight:600;
}

body{
    margin:0;
    background:black;
    color:white;
    font-family:Silka,Inter,Arial,sans-serif;
    display:flex;
    justify-content:center;
    padding:40px;
}

.container{max-width:650px;width:100%;text-align:center;}

h1{font-size:2.2rem;margin-bottom:6px;}
h3{font-size:1rem;color:#ccc;font-weight:400;margin-bottom:25px;}

.uploadBtn{
    display:inline-block;
    background:#1ED0E7;
    color:black;
    padding:14px 28px;
    border-radius:50px;
    font-weight:600;
    cursor:pointer;
    margin-top:20px;
}
.uploadBtn:hover{opacity:.9;}

.fileHint{
    margin-top:10px;
    font-size:.85rem;
    color:#aaa;
}

.button{
    background:#1ED0E7;
    color:black;
    border:none;
    padding:14px 28px;
    border-radius:50px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
    margin-top:18px;
}

.spinner{
    display:none;
    width:36px;
    height:36px;
    margin:24px auto;
    border:4px solid rgba(255,255,255,.2);
    border-top:4px solid #1ED0E7;
    border-radius:50%;
    animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

#results,#comparisonBox{
    background:#0f0f0f;
    padding:25px;
    border-radius:14px;
    margin-top:30px;
    text-align:left;
    display:none;
}

.title{color:#1ED0E7;font-size:1.3rem;margin-bottom:14px;}

input.valueField{
    width:160px;
    padding:6px 8px;
    background:#222;
    border:1px solid #555;
    border-radius:6px;
    color:#1ED0E7;
    text-align:right;
}

.warn{color:#FFD24C;font-size:.85rem;margin-bottom:10px;}

.green{color:#4CFF4C;font-size:1.8rem;font-weight:700;}
.red{color:#FF5B5B;font-size:1.8rem;font-weight:700;}

#detailsBox{
    margin-top:18px;
    background:#111;
    padding:18px;
    border-radius:8px;
    display:none;
    font-size:.95rem;
    color:#ccc;
}

.toggleExplain{
    margin-top:14px;
    color:#1ED0E7;
    cursor:pointer;
    text-decoration:underline;
}
</style>
</head>

<body>
<div class="container">

<img src="https://images.ctfassets.net/zq85bj8o2ot3/3pxy6auNcSHUkZJmPJEegu/d4652795a22a6cc0fe3dd6f753358a7a/Tibber_Logotype_1080x500_White.png?h=250"
style="width:50%;max-width:360px;margin-bottom:24px">

<h1>Fakturaanalyse</h1>
<h3>Sjekk om du kan spare med Tibber! Vår fakturaanalyse sjekker din strømregning på sekunder. Last opp en detaljert kopi som viser påslag og evt. månedsavgift. Om systemet ikke klarer å gjenkjenne verdiene, kan du fylle inn disse manuelt i neste steg.</h3>

<label for="fileInput" class="uploadBtn">Last opp strømregning</label>
<input id="fileInput" type="file" accept=".pdf,.jpg,.jpeg,.png" style="display:none">

<div class="fileHint" id="fileHint">Støttede filtyper: .jpg, .png, .pdf</div>

<button class="button" onclick="processFile()">Beregn</button>

<p style="font-size:.85rem;color:#aaa;max-width:520px;margin:12px auto">
Strømregningen din behandles kun lokalt i nettleseren din. Ingen filer eller data lagres eller sendes til Tibber eller tredjeparter.
</p>

<div id="spinner" class="spinner"></div>

<div id="results">
<div class="title">Funnet i strømregningen</div>

Forbruk (kWh):<br>
<input id="inpForbruk" class="valueField"><br>
<div id="warnForbruk" class="warn" style="display:none">Ikke funnet i strømregning - skriv inn manuelt</div>

Påslag (øre per kWh):<br>
<input id="inpPåslag" class="valueField"><br>
<div id="warnPåslag" class="warn" style="display:none">Ikke funnet i strømregning - skriv inn manuelt</div>

Månedsavgift (kr):<br>
<input id="inpMnd" class="valueField"><br>
<div id="warnMnd" class="warn" style="display:none">Ikke funnet i strømregning - skriv inn manuelt</div>

<button class="button" onclick="compareNow()">Sammenlign med Tibber</button>
</div>

<div id="comparisonBox">
<div class="title">Sammenligning</div>
<div id="comparisonResult"></div>
<div class="toggleExplain" onclick="toggleDetails()">Vis detaljert forklaring</div>
<div id="detailsBox"></div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.2/tesseract.min.js"></script>

<script>
fileInput.addEventListener("change",()=>{
    if(fileInput.files.length){
        fileHint.textContent=fileInput.files[0].name;
    }
});

function showSpinner(x){spinner.style.display=x?"block":"none";}

async function processFile(){
    if(!fileInput.files[0])return;
    showSpinner(true);
    let text="";
    const f=fileInput.files[0];
    if(f.type==="application/pdf")text=await extractPDF(f);
    else text=await extractImage(f);
    fillFields(parse(text));
    showSpinner(false);
}

async function extractPDF(f){
    const b=await f.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:b}).promise;
    let out="";
    for(let i=1;i<=pdf.numPages;i++){
        const p=await pdf.getPage(i);
        const c=await p.getTextContent();
        out+=c.items.map(t=>t.str).join(" ")+"\n";
    }
    return out;
}

async function extractImage(f){
    const r=await Tesseract.recognize(f,"nor");
    return r.data.text;
}

function classify(l){
    if(/påslag/.test(l))return"påslag";
    if(/månedsavgift|månedspris|fastpris|fastbeløp|abonnementspris|abonnementsavgift|abonnement|administrasjon|grunnbeløp/.test(l))return"mnd";
    return"";
}

function parse(t){
    const lines=t.toLowerCase().split(/\n+/);
    let f=null,p=null,m=null;
    for(let i=0;i<lines.length;i++){
        const l=lines[i];
        if(!f){const r=l.match(/(\d[\d.,]*)\s*kwh/);if(r)f=parseFloat(r[1].replace(",","."));}
        if(!p&&classify(l)==="påslag"){const r=l.match(/(\d[\d.,]*)\s*øre/);if(r&&parseFloat(r[1])<=20)p=parseFloat(r[1]);}
        if(!m&&classify(l)==="mnd"){
            let r=l.match(/(\d[\d.,]*)\s*kr/);
            if(!r&&lines[i+1])r=lines[i+1].match(/(\d[\d.,]*)\s*kr/);
            if(r)m=parseFloat(r[1].replace(",","."));}
    }
    return{forbruk:f,påslag:p,mndavg:m};
}

function fillFields(d){
    results.style.display="block";
    inpForbruk.value=d.forbruk||"";
    inpPåslag.value=d.påslag||"";
    inpMnd.value=d.mndavg||"";
}

function compareNow(){
    const f=+inpForbruk.value||0,p=+inpPåslag.value||0,m=+inpMnd.value||0;
    const diff=f*p/100+m-(f*3.4/100+49);
    comparisonResult.innerHTML=diff>0?
    `<div class="green">Du kan betale mindre med Tibber</div>Du sparer ${diff.toFixed(0)} kr per måned`:
    `<div class="red">Basert på strømregningen din blir Tibber litt dyrere for deg</div>`;
    comparisonBox.style.display="block";
}

function toggleDetails(){
    detailsBox.style.display=detailsBox.style.display==="block"?"none":"block";
}
</script>
</body>
</html>
