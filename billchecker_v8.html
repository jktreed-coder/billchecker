<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Tibber Fakturaanalyse v12.0</title>

<style>
@font-face{font-family:"Silka";src:url("Silka-Regular.woff2") format("woff2");font-weight:400;}
@font-face{font-family:"Silka";src:url("Silka-SemiBold.woff2") format("woff2");font-weight:600;}

body{margin:0;background:black;color:white;font-family:Silka,Inter,Arial,sans-serif;display:flex;justify-content:center;padding:40px;}
.container{width:100%;max-width:650px;text-align:center;}
h1{font-size:2.2rem;margin-bottom:6px;}
h3{font-size:1rem;color:#ccc;font-weight:400;margin-bottom:25px;}
.uploadBtn,.button{background:#1ED0E7;color:black;padding:14px 28px;border-radius:50px;font-weight:600;cursor:pointer;border:none}
.spinner{display:none;width:36px;height:36px;margin:24px auto;border:4px solid rgba(255,255,255,.2);border-top:4px solid #1ED0E7;border-radius:50%;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
#results,#comparisonBox{background:#0f0f0f;padding:25px;border-radius:14px;margin-top:30px;text-align:left;display:none}
input.valueField{width:160px;padding:6px 8px;background:#222;border:1px solid #555;border-radius:6px;color:#1ED0E7;text-align:right}
.warn{color:#FFD24C;font-size:.85rem;margin-bottom:10px}
.green{color:#4CFF4C;font-size:1.6rem;font-weight:700}
.red{color:#FF5B5B;font-size:1.6rem;font-weight:700}
</style>
</head>

<body>
<div class="container">

<h1>Fakturaanalyse</h1>
<h3>Last opp strømregningen din</h3>

<label for="fileInput" class="uploadBtn">Last opp</label>
<input id="fileInput" type="file" accept=".pdf,.jpg,.jpeg,.png" hidden>
<br><br>
<button class="button" onclick="processFile()">Beregn</button>

<div id="spinner" class="spinner"></div>

<div id="results">
Forbruk kWh<br>
<input id="inpForbruk" class="valueField"><div id="wF" class="warn">Ikke funnet</div>
Påslag øre per kWh<br>
<input id="inpPåslag" class="valueField"><div id="wP" class="warn">Ikke funnet</div>
Månedsavgift kr<br>
<input id="inpMnd" class="valueField"><div id="wM" class="warn">Ikke funnet</div>
<button class="button" onclick="compare()">Sammenlign</button>
</div>

<div id="comparisonBox">
<div id="comparisonResult"></div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.2/tesseract.min.js"></script>

<script>
const f=document.getElementById("fileInput");
const sp=document.getElementById("spinner");

async function processFile(){
 if(!f.files[0])return;
 sp.style.display="block";
 let t="";
 const file=f.files[0];
 if(file.type==="application/pdf"){
  t=await readPDF(file);
  t+=" "+await ocrPDF(file);
 }else{
  t=(await Tesseract.recognize(file,"nor+eng")).data.text;
 }
 const r=parse(t);
 fill(r);
 sp.style.display="none";
}

async function readPDF(file){
 const pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
 let o="";
 for(let i=1;i<=pdf.numPages;i++){
  const p=await pdf.getPage(i);
  const c=await p.getTextContent();
  o+=c.items.map(x=>x.str).join(" ")+" ";
 }
 return o;
}

async function ocrPDF(file){
 const pdf=await pdfjsLib.getDocument({data:await file.arrayBuffer()}).promise;
 let o="";
 const p=await pdf.getPage(1);
 const v=p.getViewport({scale:3});
 const c=document.createElement("canvas");
 c.width=v.width;c.height=v.height;
 await p.render({canvasContext:c.getContext("2d"),viewport:v}).promise;
 const r=await Tesseract.recognize(c,"nor+eng");
 return r.data.text;
}

function parse(raw){
 const clean=raw.toLowerCase().replace(/,/g,".").replace(/\s+/g," ");
 const num=clean.replace(/ø/g,"o");

 let forbruk=null,påslag=null,mnd=null;

 const zone=(k)=>clean.includes(k)?clean.slice(clean.indexOf(k)-150,clean.indexOf(k)+150):"";

 const kwh=[...num.matchAll(/(\d{2,6}(?:\.\d+)?)\s*kwh/g)]
  .map(x=>+x[1]).filter(v=>v>50&&v<20000);
 if(kwh.length)forbruk=Math.max(...kwh);

 const pz=zone("påslag")+zone("øre");
 const pm=[...pz.matchAll(/(\d{1,2}(?:\.\d+)?)/g)]
  .map(x=>+x[1]).filter(v=>v>0&&v<20);
 if(pm.length) påslag=pm[0];

 const mz=zone("måneds")+zone("fastbeløp")+zone("abonnement");
 const mm=[...mz.matchAll(/(\d{1,3}(?:\.\d+)?)/g)]
  .map(x=>+x[1]).filter(v=>v>0&&v<200);
 if(mm.length) mnd=mm[0];

 return{forbruk,påslag,mnd};
}

function fill(d){
 document.getElementById("results").style.display="block";
 inpForbruk.value=d.forbruk||"";wF.style.display=d.forbruk?"none":"block";
 inpPåslag.value=d.påslag||"";wP.style.display=d.påslag?"none":"block";
 inpMnd.value=d.mnd||"";wM.style.display=d.mnd?"none":"block";
}

function compare(){
 const f=+inpForbruk.value||0;
 const p=+inpPåslag.value||0;
 const m=+inpMnd.value||0;
 const diff=f*p/100+m-(f*3.4/100+49);
 comparisonBox.style.display="block";
 comparisonResult.innerHTML=diff>0
 ?`<div class="green">Du sparer ${diff.toFixed(0)} kr</div>`
 :`<div class="red">Tibber er litt dyrere</div>`;
}
</script>
</body>
</html>
