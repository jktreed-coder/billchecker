<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Tibber Fakturaanalyse</title>

<style>
@font-face{
  font-family:Silka;
  src:url(Silka-Regular.woff2) format("woff2");
  font-weight:400
}
@font-face{
  font-family:Silka;
  src:url(Silka-SemiBold.woff2) format("woff2");
  font-weight:600
}

body{
  margin:0;
  background:#000;
  color:#fff;
  font-family:Silka,Inter,Arial,sans-serif;
}

.wrapper{
  max-width:680px;
  margin:0 auto;
  padding:40px 24px;
  text-align:center;
}

.logo{
  width:220px;
  margin:0 auto 32px;
}

h1{
  font-size:2.4rem;
  margin-bottom:8px;
}

.lead{
  color:#ccc;
  font-size:1.05rem;
  line-height:1.5;
  margin-bottom:32px;
}

.primary{
  background:#1ED0E7;
  color:#000;
  border:none;
  padding:16px 32px;
  border-radius:999px;
  font-weight:600;
  cursor:pointer;
}

.fileHint{
  margin-top:10px;
  font-size:.85rem;
  color:#aaa;
}

.card{
  background:#0e0e0e;
  border-radius:16px;
  padding:28px;
  margin-top:40px;
  text-align:left;
}

.card h2{
  color:#1ED0E7;
  font-size:1.2rem;
  margin-bottom:20px;
}

label{
  display:block;
  margin-top:14px;
}

input{
  margin-top:6px;
  background:#222;
  border:1px solid #555;
  color:#1ED0E7;
  padding:8px;
  border-radius:6px;
  width:160px;
}

.warn{
  color:#FFD24C;
  font-size:.85rem;
}

.spinner{
  display:none;
  width:36px;
  height:36px;
  border:4px solid rgba(255,255,255,.2);
  border-top:4px solid #1ED0E7;
  border-radius:50%;
  margin:24px auto;
  animation:spin .9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}
</style>
</head>

<body>
<div class="wrapper">

<img class="logo" src="https://images.ctfassets.net/zq85bj8o2ot3/3pxy6auNcSHUkZJmPJEegu/d4652795a22a6cc0fe3dd6f753358a7a/Tibber_Logotype_1080x500_White.png?h=250">

<h1>Fakturaanalyse</h1>
<p class="lead">
Last opp strømregningen din. Vi identifiserer påslag og månedsavgift automatisk, uansett leverandør.
</p>

<label class="primary">
  Last opp strømregning
  <input id="fileInput" type="file" accept=".pdf,.jpg,.png" hidden>
</label>
<div class="fileHint" id="fileHint">Støttede filtyper: .jpg, .png, .pdf</div>

<button class="primary" style="margin-top:20px" onclick="process()">Beregn</button>

<div class="spinner" id="spinner"></div>

<div class="card" id="results" style="display:none">
  <h2>Funnet i strømregningen</h2>

  <label>Forbruk (kWh)
    <input id="f">
    <div class="warn" id="wf">Ikke funnet i faktura</div>
  </label>

  <label>Påslag (øre/kWh)
    <input id="p">
    <div class="warn" id="wp">Ikke funnet i faktura</div>
  </label>

  <label>Månedsavgift (kr)
    <input id="m">
    <div class="warn" id="wm">Ikke funnet i faktura</div>
  </label>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.2/tesseract.min.js"></script>

<script>
fileInput.onchange=()=>fileHint.textContent=fileInput.files[0]?.name||"";

function spin(x){spinner.style.display=x?"block":"none"}

async function process(){
  if(!fileInput.files[0])return;
  spin(true);

  const f=fileInput.files[0];
  let t="";
  if(f.type==="application/pdf"){
    const buf=await f.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    for(let i=1;i<=pdf.numPages;i++){
      const p=await pdf.getPage(i);
      const c=await p.getTextContent();
      t+=c.items.map(x=>x.str).join(" ")+"\n";
    }
  } else {
    t=(await Tesseract.recognize(f,"nor")).data.text;
  }

  parseSupplier(t.toLowerCase());
  spin(false);
}

function parseSupplier(t){
  let inSupplier=false;
  let f=null,p=null,m=null;

  t.split(/\n+/).forEach(l=>{
    if(/strøm fra/.test(l)) inSupplier=true;
    if(/nettleie/.test(l)) inSupplier=false;

    if(!inSupplier) return;

    if(!f){
      const r=l.match(/(\d[\d.,]*)\s*kwh/);
      if(r) f=+r[1].replace(",","." );
    }
    if(/påslag/.test(l)){
      const r=l.match(/(\d[\d.,]*)\s*øre/);
      if(r) p=+r[1].replace(",",".");
    }
    if(/månedsavgift|fastbeløp|abonnementsavgift|abonnement|administrasjon/.test(l)){
      const r=l.match(/(\d[\d.,]*)\s*kr/);
      if(r) m=+r[1].replace(",",".");
    }
  });

  results.style.display="block";
  fEl(f,fld=f);
}

function fEl(v,el){
  el.value=v||"";
  el.nextElementSibling.style.display=v?"none":"block";
}

const f=f, p=p, m=m;
</script>
</body>
</html>
