<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<title>Tibber Bill Checker v7</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

<style>
body { margin:0; background:black; color:white; font-family:Inter,Arial; display:flex; justify-content:center; padding:40px; }
.container { width:100%; max-width:650px; text-align:center; }

h1 { color:#1ED0E7; font-size:2.2rem; margin-bottom:10px; }
p.sub { color:#ccc; margin-bottom:25px; }

input[type="file"] { margin:20px 0; }

.button {
    background:#1ED0E7; color:black; border:none;
    padding:14px 28px; border-radius:50px;
    cursor:pointer; font-size:16px; font-weight:600;
    transition:0.25s;
}
.button:hover { transform:translateY(-2px); box-shadow:0 0 14px rgba(30,208,231,0.7); }

#spinner { display:none; margin:20px 0; }
.loader {
    border:4px solid #333; border-top:4px solid #1ED0E7;
    border-radius:50%; width:36px; height:36px;
    animation:spin 1s linear infinite; margin:auto;
}
@keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }

#results, #comparisonBox {
    background:#0f0f0f; padding:25px; border-radius:14px;
    margin-top:30px; text-align:left; display:none;
}

.title { color:#1ED0E7; font-size:1.3rem; margin-bottom:14px; }

input.valueField {
    width:160px; padding:6px 8px;
    background:#222; border:1px solid #555; border-radius:6px;
    color:#1ED0E7; font-size:1rem; text-align:right;
}

.warn {
    color:#FFD24C;
    font-size:.85rem;
    margin-left:4px;
    margin-bottom:10px;
}

.green { color:#4CFF4C; font-size:1.8rem; font-weight:700; margin-bottom:10px; }
.red { color:#FF5B5B; font-size:1.8rem; font-weight:700; margin-bottom:10px; }

#detailsBox {
    margin-top:20px;
    background:#111; padding:15px;
    border-radius:8px; display:none;
    font-size:.95rem; color:#ccc;
}

.toggleExplain {
    margin-top:12px;
    font-size:.95rem;
    cursor:pointer;
    color:#1ED0E7;
    text-decoration:underline;
}
</style>
</head>

<body>
<div class="container">

<h1>Tibber Bill Checker</h1>
<p class="sub">Sjekk om du betaler for mye i påslag og månedsavgift.</p>

<input id="fileInput" type="file" accept=".pdf,.jpg,.jpeg,.png"><br>
<button class="button" onclick="processFile()">Beregn</button>

<div id="spinner"><div class="loader"></div></div>

<div id="results">
    <div class="title">Funnet i regningen</div>

    Forbruk (kWh): <input id="inpForbruk" class="valueField"><br>
    <div id="warnForbruk" class="warn" style="display:none;">Ikke funnet i faktura – skriv inn manuelt</div>

    Påslag (øre/kWh): <input id="inpPåslag" class="valueField"><br>
    <div id="warnPåslag" class="warn" style="display:none;">Ikke funnet i faktura – skriv inn manuelt</div>

    Månedsavgift (kr): <input id="inpMnd" class="valueField"><br>
    <div id="warnMnd" class="warn" style="display:none;">Ikke funnet i faktura – skriv inn manuelt</div>

    <button class="button" onclick="compareNow()">Sammenlign med Tibber</button>
</div>

<div id="comparisonBox">
    <div class="title">Sammenligning</div>
    <div id="comparisonResult"></div>
    <div class="toggleExplain" onclick="toggleDetails()">Vis detaljert forklaring</div>
    <div id="detailsBox"></div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.2/tesseract.min.js"></script>

<script>

function showSpinner(x){ document.getElementById("spinner").style.display = x?"block":"none"; }

async function processFile(){
    const file=document.getElementById("fileInput").files[0];
    if(!file) return;

    showSpinner(true);
    document.getElementById("comparisonBox").style.display="none";

    let text="";
    try{
        if(file.type==="application/pdf") text=await extractPDF(file);
        else text=await extractImage(file);
    } catch(e){
        showSpinner(false);
        return;
    }

    text = clean(text);
    const data = parse(text);

    fillFields(data);
    showSpinner(false);
}

async function extractPDF(file){
    const buf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    let out="";
    for(let i=1;i<=pdf.numPages;i++){
        const page=await pdf.getPage(i);
        const content=await page.getTextContent();
        out+=content.items.map(t=>t.str).join(" ")+" ";
    }
    return out;
}

async function extractImage(file){
    const r=await Tesseract.recognize(file,"nor");
    return r.data.text;
}

function clean(t){
    return t.replace(/oere/gi,"øre").replace(/ore/gi,"øre").replace(/\s+/g," ").toLowerCase();
}

function fillFields(data){
    document.getElementById("results").style.display="block";

    document.getElementById("inpForbruk").value = data.forbruk || "";
    document.getElementById("warnForbruk").style.display = data.forbruk ? "none":"block";

    document.getElementById("inpPåslag").value = data.påslag || "";
    document.getElementById("warnPåslag").style.display = data.påslag ? "none":"block";

    document.getElementById("inpMnd").value = data.mndavg || "";
    document.getElementById("warnMnd").style.display = data.mndavg ? "none":"block";
}

function parse(text){

    text = text.replace(/grid rewards[\s\S]*?(kr|-kr)/gi,"");

    const find = rx => {
        const m=text.match(rx);
        return m ? m[1] : null;
    };

    /* FORBRUK */
    const all=[...text.matchAll(/(\d[\d.,]*)\s*(kwh|kwt)/gi)]
        .map(x=>parseFloat(x[1].replace(',','.')))
        .filter(x=>!isNaN(x));
    const forbruk = all.length? Math.max(...all):null;

    /* FINN PÅSLAGS-BLOKK */
    let blockMatch = text.match(/påslag[\s\S]{0,120}/i);
    let block = blockMatch ? blockMatch[0] : "";

    let påslag = null;

    if(block){
        let m = block.match(/(\d[\d.,]*)\s*øre/i);
        if(m){
            let val = parseFloat(m[1].replace(',','.'));
            if(val < 20) påslag = val;
        }
    }

    /* FALLBACK: IGNORER SPOTPRIS */
    if(!påslag){
        let candidates=[...text.matchAll(/(\d[\d.,]*)\s*øre\s*\/?\s*kwh?/gi)]
            .map(m=>parseFloat(m[1].replace(',','.')))
            .filter(v=>v<20); 
        if(candidates.length) påslag = Math.min(...candidates);
    }

    /* MÅNEDSAVGIFT */
    let mnd =
        find(/tibber-abonnement.*?(\d[\d.,]*)\s*kr/i) ||
        find(/fastbeløp.*?(\d[\d.,]*)\s*kr/i) ||
        find(/månedsavgift.*?(\d[\d.,]*)\s*kr/i) ||
        find(/fastpris.*?(\d[\d.,]*)\s*kr/i) ||
        find(/abonnementsavgift.*?(\d[\d.,]*)\s*kr/i);

    if(mnd) mnd = parseFloat(mnd.replace(',','.'));

    return {forbruk,påslag,mndavg:mnd};
}

function compareNow(){
    const f=parseFloat(document.getElementById("inpForbruk").value)||0;
    const p=parseFloat(document.getElementById("inpPåslag").value)||0;
    const m=parseFloat(document.getElementById("inpMnd").value)||0;

    const tibP=3.4, tibM=49;
    const dine=f*p/100+m;
    const tib=f*tibP/100+tibM;
    let out="";
    let year=Math.abs(dine-tib)*12;

    if(tib<dine){
        out+=`<div class='green'>Du kan betale mindre med Tibber</div>
        Du sparer ca ${(dine-tib).toFixed(0)} kr/mnd<br>Årlig: ${year.toFixed(0)} kr`;
    } else {
        out+=`<div class='red'>Tibber blir dyrere for deg</div>
        Forskjell: ${(tib-dine).toFixed(0)} kr/mnd<br>Årlig: ${year.toFixed(0)} kr`;
    }

    document.getElementById("comparisonResult").innerHTML=out;
    document.getElementById("comparisonBox").style.display="block";
}

function toggleDetails(){
    const box=document.getElementById("detailsBox");
    box.style.display=box.style.display==="none"?"block":"none";
}
</script>
</body>
</html>